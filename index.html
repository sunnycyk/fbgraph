<html>
    <head>
        <title>Facebook Related Graph</title>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <style>

            html, body {
                width: 1000;
                margin-left: auto;
                margin-right: auto;
                border: 1px solid #11111;
            }
            .node image{
                border-radius: 50%;
            }
        </style>
    </head>
    <body>
        <div id="fb-root"></div>
        <script>
            
            window.fbAsyncInit = function() {
            // init the FB JS SDK
                FB.init({
                    appId      : '150458183891',                        // App ID from the app dashboard
                    status     : true,                                 // Check Facebook Login status
                    xfbml      : true                                  // Look for social plugins on the page
                });

                FB.getLoginStatus(checkLoginStatus);
            };

            function authUser() {
                FB.login(checkLoginStatus, {scope: ''});
            }

        // Additional initialization  code such as adding Event Listeners goes here
            function checkLoginStatus(response) {
                 if (response.status === "connected") {
                        document.getElementById('loginButton').style.display = 'none';
                        fbGraph();
                    }
                    else { 
                        // display login button, user is not login
                        document.getElementById('loginButton').style.display = 'block';
                    }
            }

            function fbGraph() {
                var w=1000, h=800;
                var dataset = {
                    nodes: [],
                    edges: []
                };

                FB.api("/", 'POST', {
                            batch: [
                                {method: 'GET', relative_url: '/me?fields=name,picture'},
                                {method: 'GET', relative_url: '/me/friends?fields=name,picture'},
                                {method: 'GET', relative_url: 'method/fql.query?query=SELECT+uid1,uid2+FROM+friend+WHERE+(uid1+IN+(SELECT+uid1+FROM+friend+WHERE+uid2=me()))+AND+(uid2+IN+(SELECT+uid1+FROM+friend+WHERE+uid2=me()))+ORDER+BY+uid1'}
                            ]

                        }, function(response) {
                            var hashTable = [];
                            // Add Nodes
                            if (response && !response.error) {
                                if (response[0].code == 200)
                                    dataset.nodes.push(JSON.parse(response[0].body));
                                else return; // do nothing
                                if (response[1].code == 200) {
                                    dataset.nodes = dataset.nodes.concat(JSON.parse(response[1].body).data);
                                    dataset.nodes.forEach(function(d, i) {
                                        hashTable[d.id] = i;
                                    });
                                }
                                else return; // do nothing
                                if (response[2].code == 200) {
                                    var edges = JSON.parse(response[2].body);
                                    edges.forEach(function(d) {
                                        dataset.edges.push({source: hashTable[d.uid1], target: hashTable[d.uid2]});
                                    });
                                }

                            } 
                            // Add Edges
                            for (var i=1; i < dataset.nodes.length; i++) {
                                dataset.edges.push({source: 0, target: i});
                            }



                            
                            /*dataset.nodes.forEach(function(target, i) {
                                if (i === 0) 
                                    return;

                                 FB.api("/me/mutualfriends/" + target.id, function(response) {
                                    if (response && !response.error) {
                                        var mutualfriends = JSON.parse(response.data);
                                    }
                                })
                            });*/
                            /*FB.api("/me/mutualfriends/3219076", function(response) {
                                if (response && !response.error) {
                                    console.log(response);
                                }
                            }); */

                            var force = d3.layout.force()
                                     .nodes(dataset.nodes)
                                     .links(dataset.edges)
                                     .size([w, h])
                                     .linkDistance(dataset.nodes.length)
                                     .charge(-200)
                                     .start();


                            //Create SVG element
                            var svg = d3.select("body")
                                        .append("svg")
                                        .attr("width", w)
                                        .attr("height", h);
                            

                            //Create edges as lines
                            var edges = svg.selectAll("line")
                                .data(dataset.edges)
                                .enter()
                                .append("line")
                                .style("stroke", "#ccc")
                                .style("stroke-width", 1);
                            
                            //Create nodes as circles
                         
                            var nodes = svg.selectAll(".node")
                                .data(dataset.nodes)
                                .enter()
                                .append("g")
                                .attr('class', 'node')
                                .call(force.drag);

                            var clipPath = nodes.append("clipPath")
                                    .attr("id", function(d, i) {return "circle-mask" + i;})
                                    .append("circle")
                                    .attr("cx", "4")
                                    .attr("cy", "4")
                                    .attr("r", "12")
                                    .call(force.drag);

                            nodes = nodes.append("image")
                                        .attr("clip-path", function(d, i) { return  "url(#circle-mask" +i +")"})
                                        .attr("xlink:href", function(d) {return d.picture.data.url})

                                        .attr("x", "-8")
                                        .attr("y", "-8")
                                        .attr("width", "24")
                                        .attr("height", "24")
                                        .call(force.drag);
                                        
                            /*nodes.on("mouseover", function(d) {
                                console.log(d.name);
                            }); */
                            //Every time the simulation "ticks", this will be called
                            force.on("tick", function() {

                                edges.attr("x1", function(d) { return d.source.x; })
                                     .attr("y1", function(d) { return d.source.y; })
                                     .attr("x2", function(d) { return d.target.x; })
                                     .attr("y2", function(d) { return d.target.y; });
                            
                                nodes.attr("transform", function(d) {return "translate(" +d.x + "," + d.y + ")"; } );
                                
                            });
                });
            
            }
            
          

          // Load the SDK asynchronously
          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/all.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
        <input id="loginButton" type="button" value="Login!" onclick="authUser();" />
    </body>
</html>